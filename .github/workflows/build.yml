name: Build & Release

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    name: Build & Release APK
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required for creating GitHub Releases

    steps:
      # 1. Setup Environment
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Install Dependencies
        run: flutter pub get

      # 2. Quality Assurance
      - name: Analyze Code
        run: flutter analyze

      - name: Run Unit Tests
        run: flutter test

      # 3. Prepare Android Environment
      - name: Decode Keystore
        if: secrets.ANDROID_KEYSTORE_BASE64 != ''
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/keystore.jks
          cat > android/key.properties <<EOF
          storeFile=keystore.jks
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          EOF

      - name: Configure Android Project (Injection)
        run: |
          # 1. Inject Permissions to AndroidManifest.xml
          sed -i 's|</manifest>|<uses-permission android:name="android.permission.INTERNET"/><uses-permission android:name="android.permission.ACCESS_FINE_LOCATION"/><uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION"/><uses-permission android:name="android.permission.POST_NOTIFICATIONS"/><uses-permission android:name="android.permission.SCHEDULE_EXACT_ALARM"/></manifest>|' android/app/src/main/AndroidManifest.xml

          # 2. Inject App Name Resources
          mkdir -p android/app/src/main/res/values
          cat > android/app/src/main/res/values/strings.xml <<'XML'
          <resources>
            <string name="app_name">Al-Quran Terjemahan</string>
          </resources>
          XML

          # 3. Handle Firebase Config (if exists in repo or secrets could be added here)
          if [ -f "firebase/google-services.json" ]; then
            cp firebase/google-services.json android/app/google-services.json
            echo "Google Services JSON copied."
          else
            echo "Warning: google-services.json not found."
          fi

          # 4. Inject Gradle Configurations (Signing, Firebase Plugin, Desugaring)
          python - <<'PY'
          import os
          from pathlib import Path

          def inject_gradle_config():
              gradle_path = Path("android/app/build.gradle")
              if not gradle_path.exists():
                  print("build.gradle not found, skipping injection.")
                  return

              text = gradle_path.read_text()
              
              # Inject Keystore Config
              if "keystoreProperties" not in text:
                  keystore_snippet = (
                      "def keystoreProperties = new Properties()\n"
                      "def keystorePropertiesFile = rootProject.file('key.properties')\n"
                      "if (keystorePropertiesFile.exists()) {\n"
                      "    keystoreProperties.load(new FileInputStream(keystorePropertiesFile))\n"
                      "}
"
                      "def hasKeystore = keystorePropertiesFile.exists()\n\n"
                  )
                  if "android {" in text:
                      text = text.replace("android {", keystore_snippet + "android {", 1)
                  else:
                      text = keystore_snippet + text

              # Inject Signing Configs
              if "signingConfigs" not in text:
                  signing_snippet = (
                      "    signingConfigs {\n"
                      "        release {\n"
                      "            if (hasKeystore) {\n"
                      "                keyAlias keystoreProperties['keyAlias']\n"
                      "                keyPassword keystoreProperties['keyPassword']\n"
                      "                storeFile file(keystoreProperties['storeFile'])\n"
                      "                storePassword keystoreProperties['storePassword']\n"
                      "            }\n"
                      "        }\n"
                      "    }\n"
                  )
                  text = text.replace("android {", "android {\n" + signing_snippet, 1)

              # Apply Signing Config to Release
              if "signingConfig signingConfigs.release" not in text:
                  text = text.replace(
                      "signingConfig signingConfigs.debug",
                      "if (hasKeystore) {\n                signingConfig signingConfigs.release\n            } else {\n                signingConfig signingConfigs.debug\n            }",
                      1
                  )

              # Enable Core Library Desugaring (Java 8+ features)
              if "coreLibraryDesugaringEnabled" not in text:
                  text = text.replace("compileOptions {", "compileOptions {\n        coreLibraryDesugaringEnabled true", 1)
              
              if "desugar_jdk_libs" not in text:
                  dep_line = "    coreLibraryDesugaring 'com.android.tools:desugar_jdk_libs:2.0.4'"
                  if "dependencies {" in text:
                      text = text.replace("dependencies {", "dependencies {\n" + dep_line, 1)
                  else:
                      text += "\ndependencies {\n" + dep_line + "\n}\n"

              # Apply Google Services Plugin (for Firebase)
              if "com.google.gms.google-services" not in text:
                  text += "\napply plugin: 'com.google.gms.google-services'\n"

              gradle_path.write_text(text)
              print("android/app/build.gradle injected successfully.")

          def inject_root_gradle():
              root_gradle = Path("android/build.gradle")
              if not root_gradle.exists():
                  return
              
              text = root_gradle.read_text()
              if "com.google.gms:google-services" not in text:
                  # Add classpath dependency
                  if "dependencies {" in text:
                      text = text.replace(
                          "dependencies {", 
                          "dependencies {\n        classpath 'com.google.gms:google-services:4.4.1'", 
                          1
                      )
                  else:
                      print("Warning: Could not find dependencies block in root build.gradle")
              
              root_gradle.write_text(text)
              print("android/build.gradle injected successfully.")

          if __name__ == "__main__":
              inject_gradle_config()
              inject_root_gradle()
          PY

      - name: Prepare Assets (Adzan)
        run: |
          sudo apt-get update && sudo apt-get install -y ffmpeg
          chmod +x tools/prepare_adzan_assets.sh
          bash tools/prepare_adzan_assets.sh

      # 4. Build
      - name: Build Release APK
        run: flutter build apk --release

      - name: Verify Artifact
        run: |
          if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            echo "APK generated successfully."
            mv build/app/outputs/flutter-apk/app-release.apk "Al-Quran-Terjemahan-${{ github.ref_name }}.apk"
          else
            echo "Error: APK not found!"
            exit 1
          fi

      # 5. Release (Only on tags)
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: "Al-Quran-Terjemahan-${{ github.ref_name }}.apk"
          generate_release_notes: true